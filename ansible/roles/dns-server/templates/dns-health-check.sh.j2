#!/bin/bash
# DNS Health Check Script for ZTC DNS Server
# Generated by Ansible - DO NOT EDIT MANUALLY

DNS_SERVER="{{ dnsmasq_listen_address }}"
DNS_DOMAIN="{{ dns_domain }}"
EXPECTED_IP="{{ traefik_ingress_ip }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

check_service() {
    log "${YELLOW}Checking dnsmasq service status...${NC}"
    if systemctl is-active --quiet dnsmasq; then
        log "${GREEN}‚úÖ dnsmasq service is running${NC}"
        return 0
    else
        log "${RED}‚ùå dnsmasq service is not running${NC}"
        return 1
    fi
}

check_port() {
    log "${YELLOW}Checking DNS port 53...${NC}"
    if ss -tuln | grep -q ":53 "; then
        log "${GREEN}‚úÖ Port 53 is listening${NC}"
        return 0
    else
        log "${RED}‚ùå Port 53 is not listening${NC}"
        return 1
    fi
}

check_dns_resolution() {
    log "${YELLOW}Testing DNS resolution for ${DNS_DOMAIN}...${NC}"
    
    # Test wildcard DNS
    RESULT=$(nslookup "test.${DNS_DOMAIN}" "${DNS_SERVER}" 2>/dev/null | grep "Address:" | tail -1 | awk '{print $2}')
    
    if [ "$RESULT" = "$EXPECTED_IP" ]; then
        log "${GREEN}‚úÖ DNS resolution working correctly${NC}"
        log "   test.${DNS_DOMAIN} -> ${RESULT}"
        return 0
    else
        log "${RED}‚ùå DNS resolution failed${NC}"
        log "   Expected: ${EXPECTED_IP}"
        log "   Got: ${RESULT}"
        return 1
    fi
}

check_upstream_dns() {
    log "${YELLOW}Testing upstream DNS resolution...${NC}"
    
    # Test external domain resolution
    RESULT=$(nslookup "google.com" "${DNS_SERVER}" 2>/dev/null | grep "Address:" | wc -l)
    
    if [ "$RESULT" -gt 1 ]; then
        log "${GREEN}‚úÖ Upstream DNS working correctly${NC}"
        return 0
    else
        log "${RED}‚ùå Upstream DNS resolution failed${NC}"
        return 1
    fi
}

main() {
    log "${YELLOW}Starting DNS health check for ZTC DNS server...${NC}"
    
    ERRORS=0
    
    check_service || ((ERRORS++))
    check_port || ((ERRORS++))
    check_dns_resolution || ((ERRORS++))
    check_upstream_dns || ((ERRORS++))
    
    if [ $ERRORS -eq 0 ]; then
        log "${GREEN}üéâ All DNS health checks passed!${NC}"
        exit 0
    else
        log "${RED}üí• ${ERRORS} health check(s) failed${NC}"
        exit 1
    fi
}

# Run health check
main "$@"